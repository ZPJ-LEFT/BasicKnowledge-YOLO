# Faster RCNN

Faster R-CNN算是RCNN系列算法的最杰出产物，也是two-stage中最为经典的物体检测算法。

Faster RCNN可以看作 RPN+Fast RCNN，其中RPN使用CNN来生成候选区域，并且RPN网络可以认为是一个使用了注意力机制的候选区域选择器。

主要步骤包括：
1. 输入图像到特征提取器中，得到整张图片的feature map。
2. 使用RPN生成候选框，并投影到feature map上，得到每一个候选区域的特征矩阵。
3. 将每一个特征矩阵经过ROI Pooling缩放到7*7大小，然后经过展平处理后通过全连接层获得预测的分类以及候选区域位置偏移信息。

网络结构为VGG16+RPN+ROIHead。

## RPN网络

RPN网络是Faster RCNN的精髓所在，将传统的候选区域生成方法使用卷积运算来代替，而且根据原文作者所说，使用卷积来生成候选区域使得RPN具有一定注意力机制，效果与前几代的RCNN相比，提升明显。

首先，RPN网络接受任意尺寸大小的feat map作为输入，然后会生成9K个（为什么是9K，而不是K个，下面会有说明）anchor，并且RPN有两个输出，一个是anchor的类别信息，也就是该anchor是背景还是前景（只要有要识别的物品就属于前景），还有一个输出是该anchor的位置偏移信息（如果该anchor是背景，则该输出不重要）。

### Anchor

每一个anchor都是一个矩形框，而要表示一个矩形框就需要四个参数，作者使用了两种表示方式：
- 中心坐标+长宽：（x_center, y_center, width, height）
- 左上角坐标+右下角坐标：（x_min, y_min, x_max, y_max）

在原图中生成anchor主要分为三步：

1. 有一个base anchor，这个base anchor的尺寸可以自定义，默认尺寸为16*16。
2. 从这个base acnhor生成9个不同尺寸的anchor，可以把这9个anchor视为后续anchor的模板。
    - 两个参数，缩放scales=[8,16,32],宽高比ratios=[0.5,1,2]
    - 进行缩放，并且确保缩放后候选区域的面积不变
3. 使用9个Anchor模板在图像上生成具体的Anchor

生成Anchor后，需要经过以下处理：
1. 剔除背景：对Anchor的前景概率排序，只取前6000个
2. 裁剪：将超出图像范围的区域收回
3. 剔除尺寸很小的Anchor
4. NMS：阈值0.7，抑制后只取前300个作为结果

## 损失函数

上文有提到，RPN Head部分主要用于anchor的位置偏移预测以及anchor类别的预测，对于前文假定的图像输入，RPN Head会生成50*37*9=16650个anchor，很显然把这些全部用于训练并不合理，因为这里面有大量的负样本，所以需要先进行一波筛选，选出256个作为训练样本（这个数目是作者提出的），其中正样本128个，负样本128个，其中负样本个数肯定可以满足，但正样本基本很难会有128个，所以作者在文中说，如果正样本不足128个，则空缺部分用负样本填充，具体的训练样本筛选步骤如下：

1. 去掉所有不在图片范围的anchor，并将剩余的所有anchor的标签标记为-1；
2. 将与ground truth（gt）的IoU小于0.3的anchor作为负样本，标签记为0；
3. 将与每个gt的IoU最大的anchor作为正样本，标签记为1；
4. 将与gt的IoU不小于0.7的anchor作为正样本，标签记为1；
5. 如果某一类样本超过128个，则随机从中选择多出的样本将其标签记为-1；
6. 如果正样本小于128个，则使用负样本填充，保证总体样本数为256。
7. 仅将标签为0和1的样本用于训练，忽略标签为-1的anchor

损失函数为：

$$
L({p_{i}},{t_{i}}) = \frac{1}{N_{cls}} \sum_{i} L_{cls}(p_{i},p_{i}^{*}) + \lambda \frac{1}{N_{reg}} \sum_{i} p_{i}^{*} L_{reg}(t_{i},t_{i}^{*})
$$

- $N_{cls}$ 是mini-batch的数量,设置为256=128+128
- $\lambda \frac{1}{N_{reg}}$ 是outside_weights，应该等于256，而理论上 $N_{reg}$ 约为24000，即正负样本的数量总和
- $p_{i}$ 是第i个anchor预测为真实标签的概率
- $p_{i}^{*}$ 当是正样本时取1，负样本时取0
- $t_{i}$ 是预测边界框
- $t_{i}^{*}$ 是真实边界框

