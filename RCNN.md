# 两阶段目标检测算法RCNN

## RCNN

RCNN核心思想是将目标检测问题转化为一系列的候选区域分类问题，首先，它使用一个基于选择性搜索(Selective Search)的方法生成一组可能包含目标的候选区域。然后对每个候选区域，RCNN通过在该区域上进行前向传播提取固定长度的特征向量。最后，该特征向量被输入到一个独立的SVM分类器中，判断该区域是否包含目标，同时还有一个边界框回归器用于精确定位目标位置。

### 算法步骤：
1. **获取候选区域**，模型通过“选择搜索算法”获取潜在的候选区域
2. **获取图像特征**，截取原图每个候选区域并Resize输入到模型中进行特征提取
3. **SVM分类**，利用SVM进行分类
4. **边界框回归**，并进行BoudingBox回归

### 技术细节

#### 1. 候选区域生成（Selective Search）

先进行过分割，生成若干小区域（1k-2k），然后基于规则将可能性最高的相邻区域合并，重复直至合并为一整个区域，最后输出所有曾经存在的区域，即候选区域。

其中合并规则如下： 优先合并以下四种区域：

- 颜色（颜色直方图）相近的
- 纹理（梯度直方图）相近的
- 合并后总面积小的： 保证合并操作的尺度较为均匀，避免一个大区域陆续“吃掉”其他小区域 （例：设有区域a-b-c-d-e-f-g-h。较好的合并方式是：ab-cd-ef-gh -> abcd-efgh -> abcdefgh。 不好的合并方法是：ab-c-d-e-f-g-h ->abcd-e-f-g-h ->abcdef-gh -> abcdefgh）
- 合并后，总面积在其BBOX中所占比例大的： 保证合并后形状规则。


#### 2. 图像缩放

- 各向异性缩放：不管图像形状尺寸，直接将图像缩放至指定大小
- 各向同性缩放：先填充为正方形，再进行缩放裁剪
    - 先扩充后裁剪： 直接在原始图片中，把bounding box的边界进行扩展延伸成正方形，然后再进行裁剪；如果已经延伸到了原始图片的外边界，那么就用bounding box中的颜色均值填充；如上图(B)所示;

    - 先裁剪后扩充：先把bounding box图片裁剪出来，然后用固定的背景颜色填充成正方形图片(背景颜色也是采用bounding box的像素颜色均值),如上图(C)所示;

#### 3. 非极大值抑制判定类别

IOU = (A∩B)/(A∪B)

对于2000个检测框，输出2000*20的向量，代表20个类的概率分别，对于每一类，保留概率最大的检测框，并基于IOU排除所有重叠度超过阈值的其他边框。

#### 4. Bouding Box Regression

给定真实框的坐标Gx,Gy和高宽Gw,Gh,以及Anchor的坐标Ax,Ay和高宽Aw,Ah:

$$
G_{dx} = \frac{G_{x} - A_{x}}{G_{x}}\\
$$

$$
G_{dy} = \frac{G_{y} - A_{y}}{G_{y}}\\
$$

$$
G_{dh} = log(\frac{G_{h}}{A_{h}})\\
$$

$$
G_{dw} = log(\frac{G_{w}}{A_{w}})\\
$$


通过边界框回归得出Pdx,Pdy,Pdw,Pdh:

$$
P_{dx} = \frac{P_{x} - A_{x}}{P_{x}}\\
$$

$$
P_{dy} = \frac{P_{y} - A_{y}}{P_{y}}\\
$$

$$
P_{dh} = log(\frac{P_{h}}{A_{h}})\\
$$

$$
P_{dw} = log(\frac{P_{w}}{A_{w}})\\
$$

- 取相对值变化，是为了使不同尺度的偏移任务同化为一个任务，简化模型的学习。
- 在 RCNN 边界框回归中对宽和高取对数，能让模型更有效地学习并适配目标的比例变化，而不是简单的绝对值变化。例如10:100和100:1000是两个相同的任务，在比例上都是2倍的关系，但是如果在数值上，二者是90和900的关系，如果取对数，可以将两种情况合并为比例任务。

#### 5. 模型训练

R-CNN的训练可分成以下四步:
（1）在数据集上训练CNN 。R-CNN论文中使用的CNN网络是AlexNet，数据集为ImageNet 。
（2）在目标检测的数据集上，对训练好的CNN做微调。
（3）用Selective Search搜索候选区域，统一使用微调后的CNN对这些区域提取特征，并将提取到的特征存储起来。
（4）使用存储起来的特征，训练SVM分类器。

技术细节：
- 正负样本的选择：对于所有候选区域，将其与GT框进行IOU计算，大于某个阈值（0.3）的区域为正样本，否则为负样本
- CNN和SVM训练：先用宽松的正负样本训练CNN，再用严格的正负样本训练SVM
